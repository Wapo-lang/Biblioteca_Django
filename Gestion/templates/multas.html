{% extends "index.html" %}
{% block contenido %}
<div class="container mt-4">
    <h2 class="library-title">üí∞ {% if user.is_staff %}Gesti√≥n de Multas{% else %}Mis Multas{% endif %}</h2>

    {% if user.is_staff and pendientes %}
    <div class="alert alert-warning border-warning shadow-sm">
        <h5>‚ö†Ô∏è Pr√©stamos con Retraso Detectados (Pendientes de Sanci√≥n)</h5>
        <table class="table table-sm align-middle">
            <thead>
                <tr>
                    <th>Libro</th>
                    <th>Usuario</th>
                    <th>D√≠as de retraso</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
                {% for p in pendientes %}
                <tr>
                    <td>{{ p.libro.titulo }}</td>
                    <td>{{ p.usuario.username }}</td>
                    <td><span class="badge bg-danger">{{ p.dias_retraso }} d√≠as</span></td>
                    <td>
                        <a href="{% url 'crear_multa' p.id %}" class="btn btn-sm btn-dark">Procesar Multa</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="library-card mt-4">
        <h4>{% if user.is_staff %}Historial Global de Sanciones{% else %}Mi Historial de Sanciones{% endif %}</h4>
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Libro</th>
                    {% if user.is_staff %}<th>Socio</th>{% endif %}
                    <th>Motivo</th>
                    <th>Monto</th>
                    <th class="text-center">Estado</th>
                    {# --- NUEVA COLUMNA SOLO PARA ADMIN --- #}
                    {% if user.is_staff %}
                    <th class="text-center">Acciones</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for multa in multas %}
                <tr>
                    <td>{{ multa.fecha }}</td>
                    <td><strong>{{ multa.prestamo.libro.titulo }}</strong></td>
                    {% if user.is_staff %}<td>{{ multa.prestamo.usuario.username }}</td>{% endif %}
                    <td>{{ multa.get_tipo_multa_display }}</td>
                    <td>${{ multa.monto }}</td>
                    <td class="text-center">
                        {% if multa.pagada %}
                            <span class="badge bg-success" style="min-width: 90px;">Pagada</span>
                        {% else %}
                            <span class="badge bg-danger" style="min-width: 90px;">Pendiente</span>
                        {% endif %}
                    </td>
                    {# --- BOT√ìN DE ACCI√ìN SOLO PARA ADMIN --- #}
                    {% if user.is_staff %}
                    <td class="text-center">
                        {% if not multa.pagada %}
                            <a href="{% url 'pagar_multa' multa.id %}" class="btn btn-sm btn-outline-success">
                                ‚úÖ Marcar Pagada
                            </a>
                        {% else %}
                            <span class="text-muted small">Sin acciones</span>
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{% if user.is_staff %}7{% else %}5{% endif %}" class="text-center py-4">No se registran multas en el sistema.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}